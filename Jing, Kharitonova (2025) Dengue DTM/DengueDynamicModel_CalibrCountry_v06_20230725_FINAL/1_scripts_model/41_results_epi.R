##########################################################################################################################################################################################################
#  PROJECT: Dengue dynamic model
#  AUTHORS: Elizaveta KHARITONOVA, Anna TYTULA, Olivier CRISTEAU, Aur√©lien JAMOTTE
#  DESCRIPTION: This script contains functions that format and output the results of the transmission module
###########################################################################################################################################################################################################


#=========================================================================================================================================================================================================
#=========================================================================================================================================================================================================
#This function splits the results generated by ODE solver into categories and prepares the model output, which includes:
#-6D object with the nb of infections (used in the interface)
#-3D object with the size of host population (used in the interface)
#-1D object with the size of vector population
#-3D array with seroprevalence (/!\ This object is not used in the interface and was not fully QCed /!\)
Simulation_SplitResults<-function(res_daily,             #ODE solver output with or without information on the size of host compartments (returned by the function Simulation_Run as the object res_daily)
                                  parms_mod,             #List with all the population, transmission & intervention inputs
                                  parms_gen,             #List with simulation characteristics
                                  keep_init_state){      #Boolean indicating whether the first row of the object res_daily should be kept (the first row represents the initial state, i.e. the day before the simulation started)
  
  with(c(parms_mod, parms_mod$parms_vac_dyn_model,parms_mod$parms_epi_other, parms_gen), {
    
    #The object res_daily is organised as follows:
    #-Times (nb columns = 1)
    #-Vector compartments (nb columns = 9)
    #-Incidence records (nb columns = N_age_groups*4*3*vac_levels)
    #-Host population size records (nb columns = N_age_groups*vac_levels)
    #-Vector population size records (nb columns = 1)
    #-Seroprevalence (nb columns = N_age_groups*8)
    
    #-- Output vector times -------------------------------
    times<-res_daily[,1]                           #Simulation days, total
    length_times<-length(times)                    #Nb of simulation days, total
    if(!keep_init_state){times=times[-1]}          #Simulations day, timeframe (line for initial condition removed)
    times_year<-floor(((times-1)/365+1))           #Simulation year for each simulation day in the timeframe
    
    year<-data.frame(1:timeframe)                  #List of unique years (nb elements = timeframe)
    colnames(year)<-"year"
    
    #-- Find first column for each category ---------------
    pos_StateV<-2                                              #Vector compartments (9 columns)
    pos_nb_inf<-pos_StateV+9                                   #Nb. of infections, by age, serotype, type and vac status
    pos_pop_host<-pos_nb_inf+N_age_groups*4*3*vac_levels       #Host population size, by age and vac status
    pos_pop_vect<-pos_pop_host+N_age_groups*vac_levels         #Vector population size (1 column)
    pos_seroprev<-pos_pop_vect+1                               #Seroprevalence, by age and serostatus
    
    
    #-- Create labels for the data ------------------------
    labels_age<-apply(cbind(rep("ag", N_age_groups),1:N_age_groups), 1, paste, collapse="")             #Age --> ag1, ag2, ag3 etc. for each age group
    labels_serotype<-c("DEN1", "DEN2", "DEN3", "DEN4")                                                  #Serotype
    labels_inf_type<-c("prim", "sec","post_sec")                                                        #Type (primary, secondary, post-secondary) 
    
    if(vac_levels==1){labels_vacstatus<-c("unvac")}                                                     #Vaccination status
    else{labels_vacstatus<-c("unvac","vac_neg","vac_pos")}
    
    labels_seroprev=c("n_susc","n_1inf", "n_2inf", "n_3inf", "n_4inf")                                  #Seroprevalence
    
    
    #-- Output the nb of infections ------------------------
    nb_inf_2D_by_day_cum<-res_daily[,pos_nb_inf:(pos_pop_host-1)]                                                       #Number of infections at each simulation day (cumulative)
    nb_inf_2D_by_day<-rbind(nb_inf_2D_by_day_cum[1,], nb_inf_2D_by_day_cum[-1,]-nb_inf_2D_by_day_cum[-length_times,])   #Number of NEW infections at each simulation day (first row, then the difference between the adjacent rows)     
    if(!keep_init_state){nb_inf_2D_by_day=nb_inf_2D_by_day[-1,]}                                                        #Remove the row for the initial state (vector of zeros)                  
    nb_inf_5D_by_day<-array(nb_inf_2D_by_day, dim=c(length(times),N_age_groups,4,3,vac_levels))                         #Nb of infections in array form (by day, age, serotype, type, vac status)
    
    nb_inf_5D_by_year<-array(NA, dim=c(timeframe, N_age_groups, 4, 3, vac_levels))                                      #Aggregate by year
    for(y in 1:timeframe){
      nb_inf_5D_by_year[y,,,,]<-apply(nb_inf_5D_by_day[((y-1)*365+1):(y*365),,,,, drop=FALSE], c(2,3,4,5), sum)         
    }
    nb_inf_5D_by_year<<-nb_inf_5D_by_year
    nb_inf_6D_by_year<-ResultsEpi_ApplySeverities(nb_inf_5D_by_year=nb_inf_5D_by_year,                                  #Add a dimension for severities and calculate nb of infections of each severity 
                                                  parms_mod=parms_mod,
                                                  parms_gen=parms_gen)
    
    #-- Output host population size ------------------------
    pop_host_2D_by_day<-res_daily[,pos_pop_host:(pos_pop_vect-1)]                                        #Host populatio size at each simualtion day
    if(!keep_init_state){pop_host_2D_by_day=pop_host_2D_by_day[-1,]}
    pop_host_3D_by_day<-array(pop_host_2D_by_day, dim=c(length(times), N_age_groups, vac_levels))        #Host population size in array form (by day, age, vaccination status)   
    pop_host_3D_by_year<-array(NA,                                                                       #Aggregate average population size, by year
                               dim=c(timeframe, N_age_groups, vac_levels),
                               dimnames(list(t(year), labels_age, labels_vacstatus)))
    
    for(y in 1:timeframe){
      pop_host_3D_by_year[y,,]<-apply(pop_host_3D_by_day[((y-1)*365+1):(y*365),,, drop=FALSE], c(2,3), mean)         
    }
    
    #-- Output vector population size ----------------------
    pop_vector_by_day<-res_daily[,pos_pop_vect:(pos_seroprev-1)]                                        #Vector population size at each simulation day
    if(!keep_init_state){pop_vector_by_day=pop_vector_by_day[-1]}                                       #Remove the row for the initial state
    
    pop_vector_by_year<-data.frame(aggregate(pop_vector_by_day, list(year=times_year), mean)[,-1])      #Aggregate average population size, by year
    colnames(pop_vector_by_year)<-"pop_vector"
    rownames(pop_vector_by_year)<-t(year)
    
    #-- Seroprevalence -------------------------------------
    seroprev_by_day<-array(res_daily[,pos_seroprev:length(res_daily[1,])], dim=c(length_times,N_age_groups,8))    #Seroprevalence, by day (8 states)
    if(!keep_init_state){seroprev_by_day=seroprev_by_day[-1,,]}                                                   #Remove row for the initial state
    
    seroprev_by_year<-array(NA,                                                                                   #Aggregate seroprevalence at the end of each year (5 states)                                       
                            dim=c(timeframe, N_age_groups, 5), 
                            dimnames(list(t(year), labels_age, labels_seroprev)))
    
    for(y in 1:timeframe){
      seroprev_by_year[y,,1]<-apply(seroprev_by_day[(y*365),,1,   drop=FALSE], 2, sum)          #Fully susceptible
      seroprev_by_year[y,,2]<-apply(seroprev_by_day[(y*365),,2:5, drop=FALSE], 2, sum)          #History of one infection (any serotype)
      seroprev_by_year[y,,3]<-apply(seroprev_by_day[(y*365),,6,   drop=FALSE], 2, sum)          #History of two infections
      seroprev_by_year[y,,4]<-apply(seroprev_by_day[(y*365),,7,   drop=FALSE], 2, sum)          #History of three infections
      seroprev_by_year[y,,5]<-apply(seroprev_by_day[(y*365),,8,   drop=FALSE], 2, sum)          #History of four infections 
    }
    
    #Note: in the array seroprev_by_year is the number of hosts with each serostatus (not the proportion of the population)
    
    #-- Return results -------------------------------------
    return(list(nb_inf=nb_inf_6D_by_year,          
                pop_host=pop_host_3D_by_year,
                pop_vector=pop_vector_by_year,
                seroprev=seroprev_by_year))
  })
}

#=========================================================================================================================================================================================================
#=========================================================================================================================================================================================================
#Function that applies severities to the number of infections 

#The calculations are based on the following inputs:
#  - prop_sympt --> proportion of symptomatic infectons among all infections
#  - prop_severe_sympt --> proportion of severe infections among all symptomatic infections
#  - prop_hospit_sympt --> proportion of hospitalised infections among all symptomatic infections (as both mild and severe cases can be hospitalised)
#  - prop_death_hospit_sympt --> proportion of fatal infections out of all hospitalised symptomatic infectons (assuming that only severe hospitalised infections can have a lethal outcome)

#Each of these inputs (except for prop_death) is a vector with 3 elements (for each infection type - primary, secondary, post-secondary)

#The severity dimension has 6 levels, calculated as follows (separately for each vac status and each infection type)
#  1/ Asymptomatic                                  
#  2/ Symptomatic, mild, non-hospitalised
#  3/ Symptomatic, mild, hospitalised  
#  4/ Symptomatic, severe, non-hospitalised --> assumed to be zero (all severe are hospitalized)           
#  5/ Symptomatic, severe, hospitalised, non-fatal
#  6/ Symptomatic, severe, hospitalised, fatal

ResultsEpi_ApplySeverities<-function(nb_inf_5D_by_year,      #Array with the number of infections --> 5D array (year, age, serotype, infection type, vac status)
                                     parms_mod,              #Model parameters (to get inputs on severity distribution)
                                     parms_gen){
  
  
  
  
  
  #Create labels for the new object
  year<-data.frame(1:parms_gen$timeframe)                    #Years
  colnames(year)<-"year"
  
  labels_age<-apply(cbind(rep("ag", parms_gen$N_age_groups),1:parms_gen$N_age_groups), 1, paste, collapse="")             #Age --> ag1, ag2, ag3 etc. for each age group
  labels_serotype<-c("DEN1", "DEN2", "DEN3", "DEN4")                                                                      #Serotype
  labels_inf_type<-c("prim", "sec","post_sec")                                                                            #Type (primary, secondary, post-secondary) 
  
  if(parms_gen$vac_levels==1){labels_vacstatus<-c("unvac")}                                                               #Vaccination status
  else{labels_vacstatus<-c("unvac","vac_neg","vac_pos")}
  
  labels_severity<-c("asympt",                                                                                            #Severity
                     "sympt_mild_nonhosp","sympt_mild_hosp",
                     "sympt_severe_nonhosp","sympt_severe_hosp_nonfatal","sympt_severe_hosp_fatal")
  
  #Initialise the new array
  nb_inf_6D_by_year<-array(NA, 
                           dim=c(parms_gen$timeframe, parms_gen$N_age_groups, 4, 3, parms_gen$vac_levels, 6),
                           dimnames(list(t(year),labels_age,labels_serotype,labels_inf_type,labels_vacstatus,labels_severity)))

  # Re-calculation of required severity proportions -------
  #      For vaccinated individuals, the % of each outcome depends on the vaccine efficacy, age and simulation year
  #      This proportion was calculated in the function ParmsVacEff_GetSevDistr (script "22_parms_vac_eff.R") and is applied directly
  
  #Calculate % hospitalisations that are severe
  prop_severe_hospit<-array(NA,dim=c(parms_gen$N_age_groups, 4, 3))
  for(age in 1:(parms_gen$N_age_groups)){
    for(serotype in 1:4){
      for(type in 1:3){
        if(parms_mod$parms_epi_other$prop_hospit_sympt_unvac[age,serotype,type]>0){
          prop_severe_hospit[age,serotype,type]<-parms_mod$parms_epi_other$prop_severe_sympt_unvac[age,serotype,type]/parms_mod$parms_epi_other$prop_hospit_sympt_unvac[age,serotype,type]  #Proportion of hospitalized infections that are severe
        }else{
          prop_severe_hospit[age,serotype,type]<-0
        }
      }
    }
  }
 
  prop_mild_hospit<-1-prop_severe_hospit                                                                                   #Proportion of hospitalized infections that are mild
    
  #-------------------------------------------------------------------------------
  #---- Unvaccinated hosts -------------------------------------------------------
  #-------------------------------------------------------------------------------
  
  #Calculate proportions for each severity of interest (among all infections)
  p_asympt<-(1-parms_mod$parms_epi_other$prop_sympt_unvac)                          #Proportion asymptomatic
  p_severe<-parms_mod$parms_epi_other$prop_sympt_unvac*parms_mod$parms_epi_other$prop_severe_sympt_unvac      #Proportion severe (of all infections)
  p_mild<-parms_mod$parms_epi_other$prop_sympt_unvac*(1-parms_mod$parms_epi_other$prop_severe_sympt_unvac)    #Proportion mild (of all infections)
  p_hospit<-parms_mod$parms_epi_other$prop_sympt_unvac*parms_mod$parms_epi_other$prop_hospit_sympt_unvac      #Proportion hospitalised (of all infections)
  
  p_mild_hosp<-p_hospit*prop_mild_hospit                  #Proportion of mild, hospitalized
  p_mild_non_hosp<-p_mild-p_mild_hosp                     #Proportion mild, non-hospitalised --> all mild minus the hospitalised mild 
  
  p_severe_hosp_non_fatal<-p_hospit*prop_severe_hospit*(1-parms_mod$parms_epi_other$prop_death_hospit_sympt_unvac)  #Proportion severe, hospitalized, non-fatal
  p_severe_hosp_fatal<-p_hospit*prop_severe_hospit*parms_mod$parms_epi_other$prop_death_hospit_sympt_unvac
  
  p_severe_non_hosp<-0                                            #All severe are assumed to be hospitalized
  
  #Aggregating into an array where dimension are: severity level & the infection type & serotype
  p_sev_level<-array(NA, dim= c(6,parms_gen$N_age_groups,4,3))
  for(year in 1:parms_gen$timeframe){
    nb_inf_6D_by_year[year,,,,1,1]<-nb_inf_5D_by_year[year,,,,1]*p_asympt
    nb_inf_6D_by_year[year,,,,1,2]<-nb_inf_5D_by_year[year,,,,1]*p_mild_non_hosp
    nb_inf_6D_by_year[year,,,,1,3]<-nb_inf_5D_by_year[year,,,,1]*p_mild_hosp
    nb_inf_6D_by_year[year,,,,1,4]<-nb_inf_5D_by_year[year,,,,1]*p_severe_non_hosp
    nb_inf_6D_by_year[year,,,,1,5]<-nb_inf_5D_by_year[year,,,,1]*p_severe_hosp_non_fatal
    nb_inf_6D_by_year[year,,,,1,6]<-nb_inf_5D_by_year[year,,,,1]*p_severe_hosp_fatal
  }   
  
  #-------------------------------------------------------------------------------
  #---- Vaccinated hosts (if vaccine is included) --------------------------------
  #-------------------------------------------------------------------------------
  if(parms_gen$vac_switch){
    for(status in 1:2){
      for(year in 1:parms_gen$timeframe){    
        #----------------------
        #Calculate proportions for each severity of interest
        #----------------------
        p_asympt<-parms_mod$prop_asympt_vac[,,status,,year]         #p_asympt is an array with the % of infections that are asymptomatic by year & age (transposed so that years are rows & age groups are columns)
        p_sympt <-parms_mod$prop_sympt_vac [,,status,,year]         #Same as above but for % of symptomatic infections
        p_hospit<-parms_mod$prop_sympt_hosp_vac[,,status,,year]     #...% hospitalized (out of all infections)
        
        p_severe<-p_hospit*prop_severe_hospit                          #Assuming that mild and severe hospitalized infections are avoided uniformly
        p_mild  <-p_sympt-p_severe                                     #...% of mild (non-severe) infections (out of all infections) --> difference between the overall % of symptomatic and the overall % of severe
        p_mild_hosp<-p_hospit*prop_mild_hospit      #Proportion of mild, hospitalized --> Difference between the nb of hospitalised and the number of severe                               
        
        
        p_mild_non_hosp<-p_mild-p_mild_hosp                                                         #Proportion mild, non-hospitalized --> all mild minus the hospitalised mild 
        
        p_severe_hosp_non_fatal<-p_hospit*prop_severe_hospit*(1-parms_mod$parms_epi_other$prop_death_hospit_sympt_unvac)                      #Proportion severe, hospitalized, non-fatal --> difference between the number of hospitalisations and number of severe infections x probability of not dying (given a severe hospitalization) 
        p_severe_hosp_fatal    <-p_hospit*prop_severe_hospit*parms_mod$parms_epi_other$prop_death_hospit_sympt_unvac                          #Proportion severe, hospitalized, fatal --> difference between the number of hospitalisations and number of severe infections x probability of dying (given a severe hospitalisation) 
        p_severe_non_hosp      <-array(0,dim=c(parms_gen$N_age_groups,4,3))                            #All severe are assumed to be hospitalized
        
        #----------------------
        #Calculate the number of infections of each type
        #----------------------
        
        #Determine index for the vaccination status
        if(status==1){vac_status_ind<-2}            #vac status = 2 --> seronegative at vaccination
        if(status==2){vac_status_ind<-3}            #vac status = 3 --> seropositive at vaccination
        nb_inf_6D_by_year[year,,,,vac_status_ind,1]<-nb_inf_5D_by_year[year,,,,vac_status_ind]*p_asympt                    #Asymptomatic 
        nb_inf_6D_by_year[year,,,,vac_status_ind,2]<-nb_inf_5D_by_year[year,,,,vac_status_ind]*p_mild_non_hosp             #Symptomatic, mild, non-hospitalised
        nb_inf_6D_by_year[year,,,,vac_status_ind,3]<-nb_inf_5D_by_year[year,,,,vac_status_ind]*p_mild_hosp                 #Symptomatic, mild, hospitalised  
        nb_inf_6D_by_year[year,,,,vac_status_ind,4]<-nb_inf_5D_by_year[year,,,,vac_status_ind]*p_severe_non_hosp           #Symptomatic, severe, non-hospitalised    
        nb_inf_6D_by_year[year,,,,vac_status_ind,5]<-nb_inf_5D_by_year[year,,,,vac_status_ind]*p_severe_hosp_non_fatal     #Symptomatic, severe, hospitalised, non-fatal
        nb_inf_6D_by_year[year,,,,vac_status_ind,6]<-nb_inf_5D_by_year[year,,,,vac_status_ind]*p_severe_hosp_fatal         #Symptomatic, severe, hospitalised, fatal
        
      }
    }
  }
  
  return(nb_inf_6D_by_year)
}

